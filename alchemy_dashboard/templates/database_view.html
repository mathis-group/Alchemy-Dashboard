{% extends "base.html" %}

{% block title %}Database View - Alchemy Experiment Dashboard{% endblock %}

{% block content %}
<div class="content-area">
    <div class="sidebar">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-filter card-title-icon"></i>
                    Experiment Selection
                </h3>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label class="form-label">Select Experiment</label>
                    <select class="form-control" id="experiment_dropdown">
                        <!-- Dynamically populated with database experiments -->
                    </select>
                </div>
                <div class="status-message status-success" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span><strong>Success!</strong> Experiment data loaded.</span>
                </div>
                <button id="delete-experiment-btn" class="btn btn-danger" type="button" style="margin-top: 0.75rem;" disabled>
                    <i class="fas fa-trash"></i> Delete Experiment
                </button>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-info-circle card-title-icon"></i>
                    Experiment Details
                </h3>
            </div>
            <div class="card-body">
                {% if experiment.config_id > 0 %}
                <div class="detail-row">
                    <span class="detail-label">Generator:</span>
                    <span class="detail-value" id="generator-type">{{ experiment.generator_type }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value" id="experiment-name-display">{{ experiment.name }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Total Collisions:</span>
                    <span class="detail-value" id="total-collisions-value">{{ experiment.total_collisions }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Polling Frequency:</span>
                    <span class="detail-value" id="polling-frequency-value">{{ experiment.polling_frequency }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Timestamp:</span>
                    <span class="detail-value" id="timestamp-value">{{ experiment.timestamp }}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Generator Parameters:</span>
                </div>
                <div class="code-block">
                    {{ experiment.generator_params | tojson(indent=2) }}
                </div>

                <div id="continuation-summary" class="continuation-summary" {% if not experiment.continuation %}style="display: none;"{% endif %}>
                    <div class="detail-row">
                        <span class="detail-label">Continues From:</span>
                        <span class="detail-value" id="continuation-parent">{% if experiment.continuation %}ID {{ experiment.continuation.parent_config_id }}{% else %}-{% endif %}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Fraction Used:</span>
                        <span class="detail-value" id="continuation-fraction">{% if experiment.continuation %}{{ (experiment.continuation.fraction_used * 100) | round(1) }}%{% else %}-{% endif %}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Reused Expressions:</span>
                        <span class="detail-value" id="continuation-reused">{% if experiment.continuation %}{{ experiment.continuation.reused_expression_count }}{% else %}-{% endif %}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Added Expressions:</span>
                        <span class="detail-value" id="continuation-added">{% if experiment.continuation %}{{ experiment.continuation.additional_expression_count }}{% else %}-{% endif %}</span>
                    </div>
                </div>

                {% else %}
                <div class="detail-row">
                    <span class="detail-value">{{ experiment.name }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        {% if experiment.config_id > 0 %}
        <div class="card" id="recursive-tools-card" style="margin-top: 1.5rem;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="""></i>
                    Recursive Tools
                </h3>
            </div>
            <div class="card-body">
                <div class="detail-row">
                    <span class="detail-label">Prepare Continuation:</span>
                    <span class="detail-value">Reuse the final state with a chosen fraction for a new simulation.</span>
                </div>
                <div class="continuation-controls" style="display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; margin-top: 0.75rem;">
                    <br>
                    <label for="continuation-fraction-input" class="form-label" style="margin-bottom: 0;">Reuse Fraction (%)</label>
                    <input type="number" id="continuation-fraction-input" class="form-control" value="50" min="0" max="100" step="5" style="max-width: 110px;">
                    <button id="continue-experiment-btn" class="btn btn-secondary" type="button">
                        <i class="fas fa-play"></i> Continue Experiment
                    </button>
                </div>
                <hr style="margin: 1rem 0;">
                <div class="detail-row">
                    <span class="detail-label">Download Final State:</span>
                    <button id="download-final-state-btn" class="btn btn-link" type="button" style="padding: 0;">
                        <i class="fas fa-file-download"></i> Download Latest State
                    </button>
                </div>
                <div class="detail-row" id="download-initial-state-row" style="display: {% if experiment.continuation %}flex{% else %}none{% endif %}; align-items: center; gap: 0.5rem;">
                    <span class="detail-label">Initial Mix:</span>
                    <button id="download-initial-state-btn" class="btn btn-link" type="button" style="padding: 0;">
                        <i class="fas fa-file-download"></i> Download Applied Initial State
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="main-content db-main-content">
        {% if experiment.config_id > 0 %}
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-pie card-title-icon"></i>
                    Entropy Over Time
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" id="entropy-plots-container">
                    <div class="chart-placeholder">Select an experiment to visualize entropy.</div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line card-title-icon"></i>
                    Unique Expressions Over Time
                </h3>
            </div>
            <div class="card-body">
                <div class="chart-container" id="unique-expressions-plots-container">
                    <div class="chart-placeholder">Select an experiment to visualize unique expressions.</div>
                </div>
            </div>
        </div>

        <!-- Histogram Section -->
        <div class="card" id="state-histogram-section" style="margin-top: 2rem;">
            <div class="card-header">
                <h3 class="card-title">State Histogram at Collision</h3>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 1rem; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
                    <strong>Note:</strong> Histogram data is only available for experiments that have been imported with full state data. 
                    <br>Try experiment 15 with collision numbers like 0, 10, 20, 30, etc. for testing.
                </div>
                <form id="histogram-form" style="margin-bottom: 1rem;">
                    <label for="collision-input">Enter Collision Number:</label>
                    <input type="number" id="collision-input" name="collision_number" min="0" style="width: 120px; margin: 0 8px;">
                    <button type="submit" class="btn btn-primary">View Histogram</button>
                </form>
                <div id="histogram-content"></div>
            </div>
        </div>

        <!--- AST section -->
    
<div class="card" id="ast-visualization-section" style="margin-top: 2rem;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-project-diagram card-title-icon"></i>
            AST Visualization
        </h3>
    </div>
    <div class="card-body">
        <div style="margin-bottom: 1rem; padding: 10px; background-color: #f8f9fa; border-radius: 5px; border-left: 4px solid #007bff;">
            <strong>Note:</strong> Select an expression from the experiment to visualize its AST structure.
        </div>
        
        <form id="ast-form" style="margin-bottom: 1rem;">
            <div class="form-group">
                <label for="ast-expression-select">Select Expression:</label>
                <select id="ast-expression-select" name="expression" class="form-control" style="width: 100%; max-width: 500px;">
                    <option value="">-- Select an expression --</option>
                    <!-- Expressions will be populated dynamically -->
                </select>
            </div>
            <button type="submit" class="btn btn-primary" disabled id="ast-visualize-btn">
                <i class="fas fa-eye"></i> Visualize AST
            </button>
        </form>
        
        <div id="ast-visualization-container" class="chart-container">
            <!-- AST visualization will be rendered here -->
            <div style="text-align: center; color: #6c757d; padding: 2rem;">
                <i class="fas fa-project-diagram" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                <p>Select an expression above to visualize its AST structure</p>
            </div>
        </div>
    </div>
</div>





        <div id="entropy-details" class="card" style="margin-top: 2rem;">
            <!-- Injected dynamically -->
        </div>

        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-code card-title-icon"></i>
                    Initial Expressions
                </h3>
            </div>
            <div class="card-body">
                <div class="expression-toolbar">
                    <button id="toggle-expressions-btn" class="expression-link" type="button" data-expanded="false">
                        <i class="fas fa-eye"></i>
                        <span>Display all</span>
                    </button>
                    {% if experiment.config_id > 0 %}
                    <a id="download-expressions-link" class="expression-link" href="{{ url_for('download_initial_expressions', config_id=experiment.config_id) }}">
                        <i class="fas fa-file-download"></i>
                        <span>Download text</span>
                    </a>
                    {% endif %}
                </div>
                <div id="initial-expressions-wrapper" class="lambda-wrapper collapsed">
                    <ul class="lambda-list" id="initial-expression-list">
                        {% for expr in initial_expressions %}
                        <li class="lambda-item">{{ expr }}</li>
                        {% endfor %}
                    </ul>
                    <div class="lambda-fade"></div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body">
                <p class="text-center">No experiments available. Run a simulation to see results here.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Set the current config ID when the page loads
window.currentConfigID = {{ experiment.config_id }};

const experimentDropdown = document.getElementById('experiment_dropdown');
const deleteExperimentButton = document.getElementById('delete-experiment-btn');
const expressionsWrapper = document.getElementById('initial-expressions-wrapper');
const toggleExpressionsButton = document.getElementById('toggle-expressions-btn');
const downloadExpressionsLink = document.getElementById('download-expressions-link');
const expressionListElement = document.getElementById('initial-expression-list');
const entropyPlotsContainer = document.getElementById('entropy-plots-container');
const uniqueExpressionsPlotsContainer = document.getElementById('unique-expressions-plots-container');
const statusMessage = document.querySelector('.status-message');

function clearBokehComponentScripts() {
    document.querySelectorAll('script[data-bokeh-component]')
        .forEach(script => script.remove());
}

function setChartPlaceholders(message) {
    if (entropyPlotsContainer) {
        entropyPlotsContainer.innerHTML = `<div class="chart-placeholder">${message}</div>`;
    }
    if (uniqueExpressionsPlotsContainer) {
        uniqueExpressionsPlotsContainer.innerHTML = `<div class="chart-placeholder">${message}</div>`;
    }
}

function renderExperimentPlots(configId) {
    if (!entropyPlotsContainer || !uniqueExpressionsPlotsContainer) {
        return;
    }

    if (!configId || Number(configId) <= 0) {
        clearBokehComponentScripts();
        setChartPlaceholders('Select an experiment to visualize charts.');
        return;
    }

    clearBokehComponentScripts();
    entropyPlotsContainer.innerHTML = '<div class="chart-placeholder">Loading entropy plot…</div>';
    uniqueExpressionsPlotsContainer.innerHTML = '<div class="chart-placeholder">Loading unique expressions plot…</div>';

    fetch(`/get_experiment_plot/${configId}`)
        .then(res => res.json())
        .then(data => {
            if (data.status === "success") {
                entropyPlotsContainer.innerHTML = data.entropy_div || '<div class="chart-placeholder">No entropy data available.</div>';
                uniqueExpressionsPlotsContainer.innerHTML = data.unique_expressions_div || '<div class="chart-placeholder">No unique expressions data available.</div>';

                if (data.entropy_script) {
                    const entropyScript = document.createElement('script');
                    entropyScript.type = 'text/javascript';
                    entropyScript.dataset.bokehComponent = 'true';
                    entropyScript.textContent = data.entropy_script;
                    document.body.appendChild(entropyScript);
                }
                if (data.unique_expressions_script) {
                    const uniqueScript = document.createElement('script');
                    uniqueScript.type = 'text/javascript';
                    uniqueScript.dataset.bokehComponent = 'true';
                    uniqueScript.textContent = data.unique_expressions_script;
                    document.body.appendChild(uniqueScript);
                }
            } else {
                console.error("Failed to load plot data");
                setChartPlaceholders('Unable to load charts for the selected experiment.');
            }
            setTimeout(populateASTExpressions, 100);
        })
        .catch(err => {
            console.error('Error retrieving plots:', err);
            setChartPlaceholders('Unable to load charts for the selected experiment.');
        });
}

function updateDeleteButtonState() {
    if (!deleteExperimentButton || !experimentDropdown) {
        return;
    }
    deleteExperimentButton.disabled = !experimentDropdown.value;
}

function updateDownloadLink(configId) {
    if (!downloadExpressionsLink) {
        return;
    }
    const numericId = Number(configId);
    if (Number.isFinite(numericId) && numericId > 0) {
        downloadExpressionsLink.href = `/download_initial_expressions/${numericId}`;
        downloadExpressionsLink.style.display = 'inline-flex';
    } else {
        downloadExpressionsLink.style.display = 'none';
    }
}

function updateExpressionFade() {
    if (!expressionsWrapper) {
        return;
    }
    const fadeElement = expressionsWrapper.querySelector('.lambda-fade');
    if (!fadeElement) {
        return;
    }
    const shouldShow = !expressionsWrapper.classList.contains('expanded') &&
        expressionsWrapper.scrollHeight > expressionsWrapper.clientHeight + 1;
    fadeElement.style.display = shouldShow ? '' : 'none';
}

function setExpressionsExpanded(expanded) {
    if (!expressionsWrapper || !toggleExpressionsButton) {
        return;
    }
    expressionsWrapper.classList.toggle('expanded', expanded);
    expressionsWrapper.classList.toggle('collapsed', !expanded);
    toggleExpressionsButton.dataset.expanded = expanded ? 'true' : 'false';
    const icon = toggleExpressionsButton.querySelector('i');
    const label = toggleExpressionsButton.querySelector('span');
    if (icon) {
        icon.className = expanded ? 'fas fa-eye-slash' : 'fas fa-eye';
    }
    if (label) {
        label.textContent = expanded ? 'Hide all' : 'Display all';
    }
    requestAnimationFrame(updateExpressionFade);
}

function resetExpressionsView() {
    if (!expressionListElement) {
        return;
    }
    if (toggleExpressionsButton) {
        toggleExpressionsButton.style.display = expressionListElement.children.length > 0 ? 'inline-flex' : 'none';
    }
    setExpressionsExpanded(false);
}

window.addEventListener('resize', updateExpressionFade);

document.addEventListener("DOMContentLoaded", function() {
    updateDownloadLink(window.currentConfigID);

    if (toggleExpressionsButton) {
        toggleExpressionsButton.addEventListener('click', function() {
            const expanded = toggleExpressionsButton.dataset.expanded === 'true';
            setExpressionsExpanded(!expanded);
        });
    }

    resetExpressionsView();
    renderExperimentPlots(window.currentConfigID);

    fetch('/list_experiments')
        .then(response => response.json())
        .then(data => {
            if (data.experiments && data.experiments.length > 0 && experimentDropdown) {
                data.experiments.forEach(exp => {
                    const option = document.createElement('option');
                    option.value = exp.config_id;
                    const displayName = exp.name ? 
                        `${exp.name} (ID: ${exp.config_id})` : 
                        `Experiment ${exp.config_id}: ${exp.generator_type}`;
                    option.textContent = displayName;
                    if (String(exp.config_id) === String(window.currentConfigID)) {
                        option.selected = true;
                    }
                    experimentDropdown.appendChild(option);
                });

                if (statusMessage) {
                    statusMessage.style.display = 'block';
                }
            }
            updateDeleteButtonState();
        });

    const continueButton = document.getElementById('continue-experiment-btn');
    if (continueButton) {
        continueButton.addEventListener('click', function() {
            if (!window.currentConfigID) {
                alert('Please select an experiment to continue.');
                return;
            }
            const fractionInput = document.getElementById('continuation-fraction-input');
            const rawValue = fractionInput ? parseFloat(fractionInput.value) : 0;
            const fraction = isNaN(rawValue) ? 0 : Math.max(0, Math.min(100, rawValue));
            const targetUrl = `/simulation?continue_from=${window.currentConfigID}&fraction=${fraction}`;
            window.location.href = targetUrl;
        });
    }

    const finalDownloadButton = document.getElementById('download-final-state-btn');
    if (finalDownloadButton && window.currentConfigID) {
        finalDownloadButton.onclick = () => {
            window.location.href = `/download_final_state/${window.currentConfigID}`;
        };
    }

    const initialDownloadButton = document.getElementById('download-initial-state-btn');
    if (initialDownloadButton && window.currentConfigID) {
        initialDownloadButton.onclick = () => {
            window.location.href = `/download_initial_state/${window.currentConfigID}`;
        };
    }

    if (deleteExperimentButton) {
        deleteExperimentButton.addEventListener('click', function() {
            if (!window.currentConfigID) {
                alert('Please select an experiment to delete.');
                return;
            }
            const selectedOption = experimentDropdown ? experimentDropdown.options[experimentDropdown.selectedIndex] : null;
            const experimentLabel = selectedOption ? selectedOption.textContent : `Experiment ${window.currentConfigID}`;
            const confirmed = confirm(`Delete ${experimentLabel}? This action cannot be undone.`);
            if (!confirmed) {
                return;
            }
            fetch('/delete_experiment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ config_id: Number(window.currentConfigID) })
            })
            .then(res => res.json())
            .then(response => {
                if (response.status === 'success') {
                    window.location.reload();
                } else {
                    throw new Error(response.message || 'Failed to delete experiment');
                }
            })
            .catch(err => {
                alert(`Unable to delete experiment: ${err.message}`);
            });
        });
    }
    setTimeout(populateASTExpressions, 500);
    setupASTVisualization();

    populateASTExpressions();
});

if (experimentDropdown) {
    experimentDropdown.addEventListener('change', function () {
        const experimentId = this.value;
        window.currentConfigID = experimentId;
        updateDeleteButtonState();
        renderExperimentPlots(experimentId);

        // Fetch and update experiment metadata + expressions
        fetch(`/get_experiment_metadata/${experimentId}`)
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") {
                    const details = data.details;
                    const expressions = data.expressions;

                    document.getElementById('experiment-name-display').textContent = 
                        details.name || `Experiment ${experimentId}`;

                    const generatorTypeSpan = document.getElementById('generator-type');
                    if (generatorTypeSpan) {
                        generatorTypeSpan.textContent = details.generator_type;
                    }
                    const totalCollisionsSpan = document.getElementById('total-collisions-value');
                    if (totalCollisionsSpan) {
                        totalCollisionsSpan.textContent = details.total_collisions;
                    }
                    const pollingFrequencySpan = document.getElementById('polling-frequency-value');
                    if (pollingFrequencySpan) {
                        pollingFrequencySpan.textContent = details.polling_frequency;
                    }
                    const timestampSpan = document.getElementById('timestamp-value');
                    if (timestampSpan) {
                        timestampSpan.textContent = details.timestamp;
                    }

                    document.querySelector(".code-block").textContent = JSON.stringify(details.generator_params, null, 2);

                    if (expressionListElement) {
                        expressionListElement.innerHTML = "";
                        if (Array.isArray(expressions) && expressions.length > 0) {
                            expressions.forEach(expr => {
                                const li = document.createElement("li");
                                li.className = "lambda-item";
                                li.textContent = expr;
                                expressionListElement.appendChild(li);
                            });
                        }
                    }

                    updateDownloadLink(experimentId);
                    resetExpressionsView();

                    const continuationSummary = document.getElementById('continuation-summary');
                    const continuationParent = document.getElementById('continuation-parent');
                    const continuationFraction = document.getElementById('continuation-fraction');
                    const continuationReused = document.getElementById('continuation-reused');
                    const continuationAdded = document.getElementById('continuation-added');

                    const initialDownloadRow = document.getElementById('download-initial-state-row');
                    const initialDownloadButton = document.getElementById('download-initial-state-btn');

                    if (continuationSummary) {
                        const continuationData = details.continuation;
                        if (continuationData) {
                            continuationSummary.style.display = 'block';
                            if (continuationParent) {
                                continuationParent.textContent = `ID ${continuationData.parent_config_id}`;
                            }
                            if (continuationFraction) {
                                const fractionValue = typeof continuationData.fraction_used === 'number'
                                    ? (continuationData.fraction_used * 100).toFixed(1) + '%'
                                    : '-';
                                continuationFraction.textContent = fractionValue;
                            }
                            if (continuationReused) {
                                continuationReused.textContent = continuationData.reused_expression_count ?? '-';
                            }
                            if (continuationAdded) {
                                continuationAdded.textContent = continuationData.additional_expression_count ?? '-';
                            }
                            if (initialDownloadRow && initialDownloadButton) {
                                initialDownloadRow.style.display = 'flex';
                                initialDownloadButton.onclick = () => {
                                    window.location.href = `/download_initial_state/${experimentId}`;
                                };
                            }
                        } else {
                            continuationSummary.style.display = 'none';
                            if (initialDownloadRow) {
                                initialDownloadRow.style.display = 'none';
                            }
                        }
                    }
                    const finalDownloadButton = document.getElementById('download-final-state-btn');
                    if (finalDownloadButton) {
                        finalDownloadButton.onclick = () => {
                            window.location.href = `/download_final_state/${experimentId}`;
                        };
                    }

                    const fractionInput = document.getElementById('continuation-fraction-input');
                    if (fractionInput) {
                        fractionInput.value = 50;
                    }
                } else {
                    console.error("Failed to load experiment metadata");
                }
            });
    });
}

// Histogram manual fetch
const histogramForm = document.getElementById('histogram-form');
if (histogramForm) {
    histogramForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const collision = document.getElementById('collision-input').value;
        if (!collision || !window.currentConfigID) {
            alert('Please select an experiment first and enter a valid collision number.');
            return;
        }
        fetch(`/get_entropy_detail/${collision}?config_id=${window.currentConfigID}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                document.getElementById('histogram-content').innerHTML = html;
                document.getElementById('histogram-content').scrollIntoView({ behavior: "smooth" });
            })
            .catch(error => {
                console.error('Error fetching histogram:', error);
                document.getElementById('histogram-content').innerHTML = 
                    '<p style="color: red;">Error loading histogram. Please try again.</p>';
            });
    });
}


function populateASTExpressions() {
    const expressionSelect = document.getElementById('ast-expression-select');
    const expressionList = document.getElementById('initial-expression-list');
    
    if (!expressionSelect || !expressionList) return;
  
    expressionSelect.innerHTML = '<option value="">-- Select an expression --</option>';
    
    
    const expressionItems = expressionList.querySelectorAll('.lambda-item');
    expressionItems.forEach(item => {
        const expression = item.textContent.trim();
        if (expression) {
            const option = document.createElement('option');
            option.value = expression;
            option.textContent = expression;
            expressionSelect.appendChild(option);
        }
    });
    
    console.log(`Populated ${expressionItems.length} expressions for AST visualization`);
}




// AST fetch
function setupASTVisualization() {
    const astForm = document.getElementById('ast-form');
    const expressionSelect = document.getElementById('ast-expression-select');
    const visualizeBtn = document.getElementById('ast-visualize-btn');
    const container = document.getElementById('ast-visualization-container');

    if (!astForm || !expressionSelect) return;

  
    expressionSelect.addEventListener('change', function() {
        if (visualizeBtn) {
            visualizeBtn.disabled = !this.value;
        }
    });


    astForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const expression = expressionSelect.value;
        
        if (!expression) return;

   
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Generating AST visualization...</p>
            </div>
        `;

        fetch('/visualize_ast', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: `expression=${encodeURIComponent(expression)}`
        })
        .then(res => res.json())
        .then(data => {
          const container = document.getElementById('ast-visualization-container');

    if (data.status === 'success') {
 
        container.innerHTML = '';
        
   
        container.innerHTML = data.div; 

        const script = document.createElement('script');
        script.textContent = data.script;

        const existingScript = document.getElementById('bokeh-plot-script');
        if (existingScript) {
            existingScript.remove();
        }
        
        script.id = 'bokeh-plot-script';
        
    
        document.body.appendChild(script);

        window.dispatchEvent(new Event('resize'));
        
        console.log('AST visualization rendered successfully');
    } else {
        container.innerHTML = `<div class=\"alert alert-error\">${data.message}</div>`;
    }
})

        .catch(err => {
            console.error('Error generating visualization:', err);
            container.innerHTML = `<div class="alert alert-error">Error generating visualization: ${err.message}</div>`;
        });
    });
}

</script>
{% endblock %} 
